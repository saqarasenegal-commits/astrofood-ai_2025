<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AstroFood ‚Äì Carte Digitale (Premium Light)</title>
  <meta name="theme-color" content="#ffffff" />
  <style>
    :root{
      --bg:#fffdf8; --paper:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e5e7eb;
      --gold:#d4af37; --gold-2:#e8d18b; --accent:#0ea5e9; --pill:#f5f5f5;
      --radius:16px; --shadow:0 12px 30px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";}
    .wrap{max-width:880px; margin:24px auto; padding:0 16px}

    .card{background:var(--paper); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
    .head{display:flex; gap:16px; align-items:center; justify-content:space-between; padding:18px 22px; border-bottom:1px solid var(--line); background:linear-gradient(180deg, #fff, #fff9e8 60%)}
    .brand{display:flex; gap:10px; align-items:center}
    .logo{width:38px; height:38px; border-radius:10px; background:conic-gradient(from 0deg, var(--gold), var(--gold-2), var(--gold)); display:flex; align-items:center; justify-content:center; color:#111; font-weight:800}
    .title{margin:0}
    .title small{display:block; font-size:.8rem; color:var(--muted)}
    .badges{display:flex; gap:8px; flex-wrap:wrap}
    .badge{border:1px solid var(--line); background:var(--pill); padding:6px 10px; border-radius:999px; font-size:.82rem; color:#334155}

    .hero{display:grid; grid-template-columns: 140px 1fr 220px; gap:18px; padding:20px 22px; border-bottom:1px solid var(--line)}
    @media (max-width: 860px){ .hero{grid-template-columns:1fr; text-align:left} }
    .thumb{width:100%; aspect-ratio:1/1; border:1px solid var(--line); border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:42px; background:#fff}
    .meta{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px}
    .chip{border:1px solid var(--line); background:#fafafa; padding:8px 10px; border-radius:12px; font-size:.9rem}
    .cta{align-self:flex-start; text-align:right}
    .price{font-weight:800; color:#1f2937; font-size:1.1rem}
    .btn{display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:12px; text-decoration:none; border:1px solid var(--line); background:#111827; color:#fff; font-weight:700}
    .btn.secondary{background:#fff; color:#111827}

    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:18px; padding:20px 22px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .section{border:1px solid var(--line); border-radius:14px; padding:16px; background:#fff}
    .section h3{margin:0 0 10px; color:#111827}
    .list{margin:0; padding-left:1.1rem}
    .list li{margin:.25rem 0}

    .steps .row{display:grid; grid-template-columns:36px 1fr; gap:10px; margin:.6rem 0}
    .steps .num{width:36px; height:36px; border-radius:10px; border:1px solid var(--line); display:flex; align-items:center; justify-content:center; background:#fff}
    .note{color:var(--muted); font-size:.92rem}

    .nutri{width:100%; border-collapse:collapse; font-size:.92rem}
    .nutri th,.nutri td{border:1px solid var(--line); padding:6px 8px}
    .nutri th{background:#fcfcfc; text-align:left}

    .foot{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 22px; border-top:1px solid var(--line); background:#fff}
    .sig{font-size:.9rem; color:#64748b}

    /* Print */
    @media print{
      body{background:#fff}
      .wrap{margin:0; max-width:none; padding:0}
      .btn{display:none}
      .foot{border:0}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <article class="card" id="card">
      <header class="head">
        <div class="brand">
          <div class="logo" aria-hidden="true">‚òÖ</div>
          <h1 class="title" id="r-title">Carte Recette <small id="r-subtitle">‚Äî</small></h1>
        </div>
        <div class="badges">
          <span class="badge" id="b-sign">‚Äî</span>
          <span class="badge" id="b-state">‚Äî</span>
          <span class="badge" id="b-plan">1√ó</span>
          <span class="badge" id="b-lang">FR</span>
        </div>
      </header>

      <section class="hero">
        <div class="thumb" id="r-thumb" role="img" aria-label="Image du plat">üçΩÔ∏è</div>
        <div>
          <div class="meta" style="margin-bottom:10px">
            <div class="chip" id="c-servings">‚Äî</div>
            <div class="chip" id="c-diff">‚Äî</div>
            <div class="chip" id="c-method">‚Äî</div>
            <div class="chip" id="c-time">‚Äî</div>
            <div class="chip" id="c-cuisine">‚Äî</div>
            <div class="chip" id="c-course">‚Äî</div>
          </div>
          <p class="note" id="r-intro">‚Äî</p>
        </div>
        <div class="cta">
          <div class="price" id="r-price">‚Äî</div>
          <a class="btn" id="btn-buy" href="#" target="_blank" rel="noopener">üõí Acheter sur LemonSqueezy</a>
          <div style="margin-top:8px">
            <a class="btn secondary" id="btn-print" href="#">üñ®Ô∏è Imprimer / PDF</a>
          </div>
        </div>
      </section>

      <section class="grid">
        <div>
          <div class="section">
            <h3>Ingr√©dients</h3>
            <ul class="list" id="r-ingredients"></ul>
          </div>
          <div class="section" style="margin-top:12px">
            <h3>Ustensiles</h3>
            <ul class="list" id="r-equipment"></ul>
          </div>
          <div class="section steps" style="margin-top:12px">
            <h3>√âtapes</h3>
            <div id="r-steps"></div>
          </div>
        </div>
        <aside>
          <div class="section">
            <h3>Valeurs nutritionnelles (‚âà/portion)</h3>
            <table class="nutri" id="r-nutri"></table>
          </div>
          <div class="section" style="margin-top:12px">
            <h3>Allerg√®nes & Substitutions</h3>
            <p class="note" id="r-allergens">‚Äî</p>
            <p class="note" id="r-subs" style="margin-top:6px">‚Äî</p>
          </div>
          <div class="section" style="margin-top:12px">
            <h3>Conservation & R√©chauffage</h3>
            <p class="note" id="r-storage">‚Äî</p>
          </div>
        </aside>
      </section>

      <footer class="foot">
        <div class="sig">¬© AstroFood Premium Gold ‚Äî eatbythestars.com</div>
        <div>
          <a class="btn secondary" id="btn-copy-url" href="#">Copier l‚ÄôURL</a>
        </div>
      </footer>
    </article>
  </div>

  <script>
  (function(){
    'use strict';

    // 1) Params & i18n minimal
    const qs = new URLSearchParams(location.search);
    const lang = (qs.get('lang') || 'fr').toLowerCase();
    const sign = (qs.get('sign') || 'aries').toLowerCase();
    const state = (qs.get('state') || 'detox').toLowerCase();
    const plan = (qs.get('plan') || 'single').toLowerCase();

    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';

    const SIGN_LABEL = { fr:{aries:'B√©lier',taurus:'Taureau',gemini:'G√©meaux',cancer:'Cancer',leo:'Lion',virgo:'Vierge',libra:'Balance',scorpio:'Scorpion',sagittarius:'Sagittaire',capricorn:'Capricorne',aquarius:'Verseau',pisces:'Poissons'},
                         en:{aries:'Aries',taurus:'Taurus',gemini:'Gemini',cancer:'Cancer',leo:'Leo',virgo:'Virgo',libra:'Libra',scorpio:'Scorpio',sagittarius:'Sagittarius',capricorn:'Capricorn',aquarius:'Aquarius',pisces:'Pisces'},
                         ar:{aries:'ÿßŸÑÿ≠ŸÖŸÑ',taurus:'ÿßŸÑÿ´Ÿàÿ±',gemini:'ÿßŸÑÿ¨Ÿàÿ≤ÿßÿ°',cancer:'ÿßŸÑÿ≥ÿ±ÿ∑ÿßŸÜ',leo:'ÿßŸÑÿ£ÿ≥ÿØ',virgo:'ÿßŸÑÿπÿ∞ÿ±ÿßÿ°',libra:'ÿßŸÑŸÖŸäÿ≤ÿßŸÜ',scorpio:'ÿßŸÑÿπŸÇÿ±ÿ®',sagittarius:'ÿßŸÑŸÇŸàÿ≥',capricorn:'ÿßŸÑÿ¨ÿØŸä',aquarius:'ÿßŸÑÿØŸÑŸà',pisces:'ÿßŸÑÿ≠Ÿàÿ™'} };

    // 2) E-commerce config
    const LS_URL = window.LEMONSQUEEZY_URL || 'https://astrofood.lemonsqueezy.com/buy/PRODUCT_ID';

    // 3) Helpers
    const $ = (id)=>document.getElementById(id);
    const setText = (id, value)=>{ const el=$(id); if(!el) return; el.textContent = value??'‚Äî'; };
    const setHTMLSafeLines = (id, value)=>{ const el=$(id); if(!el) return; el.textContent = value?String(value):'‚Äî'; };

    function fillList(id, arr, mapFn){
      const root = $(id); if (!root) return; root.innerHTML = '';
      (arr||[]).forEach((x)=>{
        const li = document.createElement('li');
        li.textContent = mapFn? mapFn(x): String(x);
        root.appendChild(li);
      });
    }
    function addStep(container, idx, s){
      const row = document.createElement('div'); row.className='row';
      const num = document.createElement('div'); num.className='num'; num.textContent = String(s.n || (idx+1));
      const body = document.createElement('div');
      const text = document.createElement('div'); text.textContent = s.text || '';
      body.appendChild(text);
      if (s.timer_sec){ const t=document.createElement('div'); t.className='note'; t.textContent = '‚è≤Ô∏è ' + Math.round(s.timer_sec/60) + ' min'; body.appendChild(t); }
      if (s.heat){ const h=document.createElement('div'); h.className='note'; h.textContent = 'üî• ' + s.heat; body.appendChild(h); }
      row.appendChild(num); row.appendChild(body);
      container.appendChild(row);
    }

    function renderNutrition(tbl, n){
      const rows = [
        ['√ânergie', n?.kcal ? n.kcal + ' kcal' : '‚Äî'],
        ['Prot√©ines', n?.protein_g ? n.protein_g + ' g' : '‚Äî'],
        ['Glucides', n?.carb_g ? n.carb_g + ' g' : '‚Äî'],
        ['Lipides', n?.fat_g ? n.fat_g + ' g' : '‚Äî']
      ];
      if (n?.fiber_g) rows.push(['Fibres', n.fiber_g + ' g']);
      if (n?.sugar_g) rows.push(['Sucres', n.sugar_g + ' g']);
      tbl.innerHTML = '';
      rows.forEach(([k,v])=>{
        const tr = document.createElement('tr');
        const th = document.createElement('th'); th.textContent = k;
        const td = document.createElement('td'); td.textContent = v;
        tr.appendChild(th); tr.appendChild(td); tbl.appendChild(tr);
      });
    }

    function priceCFA(n){ return (typeof n === 'number' && isFinite(n)) ? new Intl.NumberFormat('fr-FR').format(n) + ' CFA / recette' : '‚Äî'; }

    // 4) Set header badges
    setText('b-sign', (SIGN_LABEL[lang]||SIGN_LABEL.fr)[sign] || sign);
    setText('b-state', state);
    setText('b-plan', (plan==='daily3') ? '3√ó' : '1√ó');
    setText('b-lang', lang.toUpperCase());

    // 5) Fetch data from API
    const API_URL = window.ASTROFOOD_API_URL || '/api/astrofood';

    async function load(){
      const payload = { lang, sign, state, plan, mode: 'recipe' };
      const r = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const data = await r.json();
      const d = data.recipe || data;

      // Title & subtitle
      setText('r-title', d.title || 'Recette');
      setText('r-subtitle', d.subtitle || '');

      // Thumb (emoji or initial)
      const emoji = d.image_emoji || d.emoji || 'üçΩÔ∏è';
      $('r-thumb').textContent = emoji;

      // Meta chips
      setText('c-servings', d.servings ? d.servings + ' portions' : '‚Äî');
      setText('c-diff', d.difficulty || '‚Äî');
      setText('c-method', d.method || '‚Äî');
      const total = d.time?.total || ((d.time?.prep||0) + (d.time?.cook||0) || null);
      setText('c-time', total ? ('Total: ' + total + ' min') : '‚Äî');
      setText('c-cuisine', d.cuisine || '‚Äî');
      setText('c-course', d.course || '‚Äî');

      // Intro
      setHTMLSafeLines('r-intro', d.intro || d.description || '');

      // Price & buy
      $('r-price').textContent = priceCFA(d.price_cfa);
      $('btn-buy').href = LS_URL;

      // Ingredients
      fillList('r-ingredients', d.ingredients, (it)=>{
        const qty = (it && (it.qty !== undefined)) ? String(it.qty) : '';
        const unit = (it && it.unit) ? (' ' + it.unit) : '';
        const name = it?.item || '';
        const notes = it?.notes ? (' ‚Äî ' + it.notes) : '';
        return (qty + unit).trim() + ( (qty||unit)? ' ‚Ä¢ ' : '') + name + notes;
      });

      // Equipment
      fillList('r-equipment', d.equipment, (t)=> String(t));

      // Steps
      const steps = $('r-steps'); steps.innerHTML = '';
      (d.steps||[]).forEach((s,i)=> addStep(steps,i,s));

      // Nutrition
      renderNutrition($('r-nutri'), d.nutrition);

      // Allergens / substitutions / storage
      setText('r-allergens', (d.allergens && d.allergens.length) ? d.allergens.join(', ') : '‚Äî');
      setText('r-subs', (d.substitutions && d.substitutions.length) ? d.substitutions.join(' ‚Ä¢ ') : '‚Äî');
      if (d.storage){
        const parts = [];
        if (d.storage.fridge_days) parts.push('Frigo: ' + d.storage.fridge_days + ' j.');
        if (d.storage.freezer_days) parts.push('Cong√©lateur: ' + d.storage.freezer_days + ' j.');
        if (d.storage.reheat) parts.push('R√©chauffage: ' + d.storage.reheat);
        setText('r-storage', parts.join(' ‚Ä¢ ') || '‚Äî');
      } else {
        setText('r-storage', '‚Äî');
      }
    }

    // 6) Actions
    $('btn-print').addEventListener('click', (e)=>{ e.preventDefault(); window.print(); });
    $('btn-copy-url').addEventListener('click', async (e)=>{ e.preventDefault(); try{ await navigator.clipboard.writeText(location.href); alert('URL copi√©e ‚úÖ'); }catch(_){ alert('Impossible de copier'); }});

    // 7) Load
    load().catch(err=>{
      console.error(err);
      $('r-steps').innerHTML = '<p class="note">‚ùå Impossible de charger la recette.</p>';
    });
  })();
  </script>
</body>
</html>
